<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 780">
  <defs>
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#11998e;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#38ef7d;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f093fb;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f5576c;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="dbGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4facfe;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ee0979;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ff6a00;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="resetGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#fc4a1a;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f7b733;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="batchGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#8e2de2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4a00e0;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
    </filter>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#38ef7d"/>
    </marker>
    <marker id="arrowCyan" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#00f2fe"/>
    </marker>
    <marker id="arrowPink" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f5576c"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f7b733"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8e2de2"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="900" height="780" fill="#1a1a2e"/>
  
  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="20" font-weight="bold">Fluxo de Sincronização - Campos Aplicáveis</text>
  <text x="450" y="50" text-anchor="middle" fill="#a0aec0" font-family="Arial, sans-serif" font-size="11">POST /normas/sync-aplicavel → NormasService.syncAplicavel()</text>
  
  <!-- Start Node -->
  <ellipse cx="450" cy="90" rx="70" ry="28" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="450" y="87" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">POST</text>
  <text x="450" y="100" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="Arial, sans-serif" font-size="9">/normas/sync-aplicavel</text>
  
  <!-- Arrow to Step 1 -->
  <path d="M 450 118 L 450 140" stroke="#667eea" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Step 1: Reset All -->
  <rect x="300" y="145" width="300" height="55" rx="8" fill="url(#resetGrad)" filter="url(#shadow)"/>
  <text x="450" y="167" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">1. Reset Todas as Normas</text>
  <text x="450" y="182" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-family="Arial, sans-serif" font-size="9">UPDATE tb_normas_consolidadas</text>
  <text x="450" y="194" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-family="Arial, sans-serif" font-size="8">SET aplicavel = false, sistema_gestao = NULL</text>
  
  <!-- Arrow to Step 2 -->
  <path d="M 450 200 L 450 225" stroke="#f7b733" stroke-width="2" marker-end="url(#arrowOrange)"/>
  
  <!-- Step 2: Query Management DB -->
  <rect x="300" y="230" width="300" height="60" rx="8" fill="url(#dbGrad)" filter="url(#shadow)"/>
  <text x="450" y="252" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">2. Buscar Classificações</text>
  <text x="450" y="267" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-family="Arial, sans-serif" font-size="9">management_systems_classifications.db</text>
  <text x="450" y="282" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-family="Arial, sans-serif" font-size="8">WHERE classification = true → norm_id, mngm_sys</text>
  
  <!-- Arrow to Decision 1 -->
  <path d="M 450 290 L 450 320" stroke="#00f2fe" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- Decision 1: Has Classifications? -->
  <polygon points="450,325 540,375 450,425 360,375" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="450" y="365" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Encontrou</text>
  <text x="450" y="380" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="10" font-weight="bold">classificações?</text>
  
  <!-- No branch - Return empty -->
  <path d="M 540 375 L 680 375" stroke="#f5576c" stroke-width="2" marker-end="url(#arrowPink)"/>
  <text x="610" y="365" text-anchor="middle" fill="#f5576c" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Não</text>
  
  <rect x="685" y="350" width="170" height="50" rx="8" fill="#4a5568" stroke="#f5576c" stroke-width="2"/>
  <text x="770" y="370" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Retorno Vazio</text>
  <text x="770" y="385" text-anchor="middle" fill="#a0aec0" font-family="Arial, sans-serif" font-size="8">{ updated: 0 }</text>
  
  <!-- Arrow from empty to end -->
  <path d="M 770 400 L 770 720 L 510 720" stroke="#f5576c" stroke-width="2" fill="none" marker-end="url(#arrowPink)"/>
  
  <!-- Yes branch -->
  <path d="M 450 425 L 450 455" stroke="#38ef7d" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="465" y="445" fill="#38ef7d" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Sim</text>
  
  <!-- Step 3: Group by norm_id -->
  <rect x="300" y="460" width="300" height="55" rx="8" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="450" y="480" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">3. Agrupar por Norma</text>
  <text x="450" y="495" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-family="Arial, sans-serif" font-size="9">normasSistemas: Record&lt;norm_id, mngm_sys[]&gt;</text>
  <text x="450" y="508" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-family="Arial, sans-serif" font-size="8">Uma norma pode ter múltiplos sistemas de gestão</text>
  
  <!-- Arrow to Step 4 -->
  <path d="M 450 515 L 450 545" stroke="#38ef7d" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- Step 4: Build CASE WHEN -->
  <rect x="275" y="550" width="350" height="70" rx="8" fill="url(#batchGrad)" filter="url(#shadow)"/>
  <text x="450" y="572" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">4. Construir Query Otimizada</text>
  <text x="450" y="588" text-anchor="middle" fill="rgba(255,255,255,0.9)" font-family="Arial, sans-serif" font-size="9">UPDATE em lote com CASE WHEN</text>
  <text x="450" y="602" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-family="Arial, sans-serif" font-size="8">SET aplicavel = true, sistema_gestao = CASE id</text>
  <text x="450" y="614" text-anchor="middle" fill="rgba(255,255,255,0.7)" font-family="Arial, sans-serif" font-size="8">WHEN norm_id THEN 'ISO 14001, ISO 45001' ...</text>
  
  <!-- Arrow to Step 5 -->
  <path d="M 450 620 L 450 645" stroke="#8e2de2" stroke-width="2" marker-end="url(#arrowPurple)"/>
  
  <!-- Step 5: Execute Batch Update -->
  <rect x="300" y="650" width="300" height="50" rx="8" fill="url(#dbGrad)" filter="url(#shadow)"/>
  <text x="450" y="670" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="11" font-weight="bold">5. Executar Update em Lote</text>
  <text x="450" y="687" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="Arial, sans-serif" font-size="9">WHERE id IN (norm_ids...)</text>
  
  <!-- Arrow to End -->
  <path d="M 450 700 L 450 720" stroke="#00f2fe" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- End Node -->
  <ellipse cx="450" cy="745" rx="60" ry="25" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="450" y="743" text-anchor="middle" fill="#fff" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Retorno</text>
  <text x="450" y="755" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="Arial, sans-serif" font-size="8">{ updated: count }</text>
  
  <!-- Database Legend Box - Left -->
  <rect x="30" y="145" width="220" height="130" rx="8" fill="rgba(79,172,254,0.1)" stroke="#4facfe" stroke-width="1"/>
  <text x="140" y="165" text-anchor="middle" fill="#4facfe" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Bancos de Dados</text>
  
  <rect x="45" y="180" width="15" height="15" rx="3" fill="#4facfe"/>
  <text x="70" y="192" fill="#fff" font-family="Arial, sans-serif" font-size="9">tb_normas_consolidadas</text>
  <text x="70" y="204" fill="#a0aec0" font-family="Arial, sans-serif" font-size="7">DuckDB Local - Dados principais</text>
  
  <rect x="45" y="215" width="15" height="15" rx="3" fill="#00f2fe"/>
  <text x="70" y="227" fill="#fff" font-family="Arial, sans-serif" font-size="9">management_systems_classifications</text>
  <text x="70" y="239" fill="#a0aec0" font-family="Arial, sans-serif" font-size="7">DuckDB - Classificações IA</text>
  
  <text x="70" y="260" fill="#a0aec0" font-family="Arial, sans-serif" font-size="8">Campos: norm_id, mngm_sys, classification</text>
  
  <!-- Fields Legend Box - Left -->
  <rect x="30" y="290" width="220" height="110" rx="8" fill="rgba(56,239,125,0.1)" stroke="#38ef7d" stroke-width="1"/>
  <text x="140" y="310" text-anchor="middle" fill="#38ef7d" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Campos Atualizados</text>
  
  <text x="45" y="330" fill="#fff" font-family="Arial, sans-serif" font-size="9">• aplicavel (boolean)</text>
  <text x="55" y="345" fill="#a0aec0" font-family="Arial, sans-serif" font-size="7">true se classification = true</text>
  
  <text x="45" y="365" fill="#fff" font-family="Arial, sans-serif" font-size="9">• sistema_gestao (string)</text>
  <text x="55" y="380" fill="#a0aec0" font-family="Arial, sans-serif" font-size="7">Lista de sistemas: "ISO 14001, ISO 45001"</text>
  
  <!-- Result Box - Right -->
  <rect x="685" y="550" width="180" height="130" rx="8" fill="rgba(56,239,125,0.1)" stroke="#38ef7d" stroke-width="1"/>
  <text x="775" y="572" text-anchor="middle" fill="#38ef7d" font-family="Arial, sans-serif" font-size="11" font-weight="bold">Resposta</text>
  
  <text x="700" y="595" fill="#a0aec0" font-family="Arial, sans-serif" font-size="9">{</text>
  <text x="710" y="612" fill="#4facfe" font-family="Arial, sans-serif" font-size="9">"message":</text>
  <text x="710" y="627" fill="#38ef7d" font-family="Arial, sans-serif" font-size="8">"Sincronização concluída"</text>
  <text x="710" y="645" fill="#4facfe" font-family="Arial, sans-serif" font-size="9">"updated":</text>
  <text x="778" y="645" fill="#f7b733" font-family="Arial, sans-serif" font-size="9">number</text>
  <text x="700" y="662" fill="#a0aec0" font-family="Arial, sans-serif" font-size="9">}</text>
  
  <!-- Performance Note Box -->
  <rect x="30" y="420" width="220" height="90" rx="8" fill="rgba(142,45,226,0.1)" stroke="#8e2de2" stroke-width="1"/>
  <text x="140" y="440" text-anchor="middle" fill="#8e2de2" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Otimização</text>
  
  <text x="45" y="460" fill="#fff" font-family="Arial, sans-serif" font-size="8">• Update em lote (CASE WHEN)</text>
  <text x="45" y="475" fill="#fff" font-family="Arial, sans-serif" font-size="8">• Evita múltiplos UPDATEs</text>
  <text x="45" y="490" fill="#fff" font-family="Arial, sans-serif" font-size="8">• Reset geral antes do sync</text>
  <text x="45" y="505" fill="#a0aec0" font-family="Arial, sans-serif" font-size="7">Garante consistência dos dados</text>
  
  <!-- Flow Description -->
  <rect x="685" y="460" width="180" height="75" rx="8" fill="rgba(102,126,234,0.1)" stroke="#667eea" stroke-width="1"/>
  <text x="775" y="480" text-anchor="middle" fill="#667eea" font-family="Arial, sans-serif" font-size="10" font-weight="bold">Endpoint</text>
  <text x="700" y="500" fill="#a0aec0" font-family="Arial, sans-serif" font-size="8">Route: POST /normas/sync-aplicavel</text>
  <text x="700" y="515" fill="#a0aec0" font-family="Arial, sans-serif" font-size="8">Controller: NormasController</text>
  <text x="700" y="530" fill="#a0aec0" font-family="Arial, sans-serif" font-size="8">Service: NormasService</text>
</svg>